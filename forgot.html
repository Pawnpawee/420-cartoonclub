<!DOCTYPE html>
<html lang="th">
<head>
<script>document.write('\n<div id="site-loader" aria-hidden="false" role="status" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;background:#fff5df;z-index:99999;transition:opacity .35s ease,visibility .35s;">\n  <img src="img/logo_cartoonclub.png" alt="Cartoon Club" style="width:140px;height:auto;margin-bottom:12px;"/>\n  <div style="display:flex;gap:10px;align-items:center;">\n    <span style="width:12px;height:12px;border-radius:50%;background:#c1272d;opacity:.25;display:inline-block;animation:jump 900ms infinite ease-in-out;"></span>\n    <span style="width:12px;height:12px;border-radius:50%;background:#c1272d;opacity:.25;display:inline-block;animation:jump 900ms infinite ease-in-out;animation-delay:120ms;"></span>\n    <span style="width:12px;height:12px;border-radius:50%;background:#c1272d;opacity:.25;display:inline-block;animation:jump 900ms infinite ease-in-out;animation-delay:240ms;"></span>\n  </div>\n  <style>\n    @keyframes jump{0%,80%,100%{transform:translateY(0);opacity:.25}40%{transform:translateY(-10px);opacity:1}}\n    .site-loader-hidden{opacity:0;visibility:hidden;pointer-events:none}\n  </style>\n  <script>\n    (function(){\n      function hide(){var e=document.getElementById(\'site-loader\'); if(!e) return; e.classList.add(\'site-loader-hidden\'); setTimeout(function(){ if(e && e.parentNode) e.parentNode.removeChild(e); },450);}\n      window.hideSiteLoader = hide;\n      window.addEventListener(\'load\', function(){ setTimeout(hide, 150); });\n    })();\n  <\/script>\n</div>\n');</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ลืมรหัสผ่าน | Cartoon Club</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script type="module" src="./firebase-controller.js"></script>
  <link rel="stylesheet" href="css/global.css">
  <link rel="stylesheet" href="css/forgot.css">

</head>
<body class="forgot-page">
  <!-- Navbar Component -->
  <div id="navbar"></div>
  <div class="center">
    <img src="img/Logo Cartoon Club.png" alt="Logo" class="logo" />
    <div class="forgot-box">
      <div class="forgot-title">อัปเดตรหัสผ่าน</div>
      <form id="forgotForm">
        <div class="input-group">
          <span class="input-label">อีเมล</span>
          <input type="email" class="input-field" id="forgotEmail" placeholder="กรอกอีเมล" required>
        </div>
        <button type="submit" class="forgot-btn">ถัดไป</button>
      </form>
      <div class="recaptcha">หน้านี้ได้รับการป้องกันโดย Google reCAPTCHA เพื่อตรวจสอบว่าคุณไม่ใช่บอต<br><a href="#" class="recaptcha-link">ดูข้อมูลเพิ่มเติม</a></div>
    </div>
  </div>
  <!-- Footer Component -->
  <div id="footer"></div>
  <!-- Lenis: smooth scroll lib (jsDelivr) -->
  <script src="https://cdn.jsdelivr.net/npm/lenis@1.3.15/dist/lenis.min.js"></script>
  <script type="module" src="js/navbar.js"></script>
  <script src="js/footer.js"></script>

  <script type="module">
    import { sendResetEmail } from './firebase-controller.js';
    
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('forgotForm');
      if (form) {
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          const email = document.getElementById('forgotEmail').value;
          try {
            await sendResetEmail(email);
            showPopup('ส่งอีเมลรีเซ็ตรหัสผ่านแล้ว กรุณาตรวจสอบอีเมลของคุณ', () => {
              window.location.href = 'login.html';
            });
          } catch (err) {
            showPopup('ไม่สามารถส่งอีเมลรีเซ็ตรหัสผ่าน: ' + err.message);
          }
        });
      }
    });
    
    function showPopup(message, callback) {
      // Remove existing popup if any
      const existing = document.getElementById('loginPopup');
      if (existing) existing.remove();

      // Create modal structure using the project's modal classes so it picks up modal styling
      const wrapper = document.createElement('div');
      wrapper.id = 'loginPopup';
      wrapper.className = 'modal show';
      wrapper.innerHTML = `
        <div class="modal-content modal-figma" role="dialog" aria-modal="true">
          <div class="modal-figma-inner">
            <div class="modal-figma-text">
              <h1 class="modal-figma-title">${message}</h1>
            </div>
          </div>
          <div class="modal-footer modal-footer-figma">
            <button type="button" class="btn-figma-primary" id="loginPopupOk">ตกลง</button>
          </div>
        </div>
      `;

      // Append and focus
      document.body.appendChild(wrapper);

      // Prevent page scroll while modal is open
      document.body.style.overflow = 'hidden';

      // Close handler
      function closePopup(doCallback = false) {
        const el = document.getElementById('loginPopup');
        if (el) el.remove();
        document.body.style.overflow = '';
        document.removeEventListener('keydown', onKeyDown);
        if (doCallback && typeof callback === 'function') callback();
      }

      // Click outside to close
      wrapper.addEventListener('click', (e) => {
        if (e.target === wrapper) closePopup(false);
      });

      // ESC to close
      function onKeyDown(e) {
        if (e.key === 'Escape') closePopup(false);
      }
      document.addEventListener('keydown', onKeyDown);

      // OK button
      const okBtn = document.getElementById('loginPopupOk');
      if (okBtn) {
        okBtn.addEventListener('click', () => closePopup(true));
      }
    }
  </script>
</body>
</html>
