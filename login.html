<!DOCTYPE html>
<html lang="th">

<head>
  <script>document.write('\n<div id="site-loader" aria-hidden="false" role="status" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;background:#fff5df;z-index:99999;transition:opacity .35s ease,visibility .35s;">\n  <img src="img/logo_cartoonclub.png" alt="Cartoon Club" style="width:140px;height:auto;margin-bottom:12px;"/>\n  <div style="display:flex;gap:10px;align-items:center;">\n    <span style="width:12px;height:12px;border-radius:50%;background:#c1272d;opacity:.25;display:inline-block;animation:jump 900ms infinite ease-in-out;"></span>\n    <span style="width:12px;height:12px;border-radius:50%;background:#c1272d;opacity:.25;display:inline-block;animation:jump 900ms infinite ease-in-out;animation-delay:120ms;"></span>\n    <span style="width:12px;height:12px;border-radius:50%;background:#c1272d;opacity:.25;display:inline-block;animation:jump 900ms infinite ease-in-out;animation-delay:240ms;"></span>\n  </div>\n  <style>\n    @keyframes jump{0%,80%,100%{transform:translateY(0);opacity:.25}40%{transform:translateY(-10px);opacity:1}}\n    .site-loader-hidden{opacity:0;visibility:hidden;pointer-events:none}\n  </style>\n  <script>\n    (function(){\n      function hide(){var e=document.getElementById(\'site-loader\'); if(!e) return; e.classList.add(\'site-loader-hidden\'); setTimeout(function(){ if(e && e.parentNode) e.parentNode.removeChild(e); },450);}\n      window.hideSiteLoader = hide;\n      window.addEventListener(\'load\', function(){ setTimeout(hide, 150); });\n    })();\n  <\/script>\n</div>\n');</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>เข้าสู่ระบบ | Cartoon Club</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script type="module" src="./firebase-controller.js"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;700&family=Noto+Sans+Thai:wght@400;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="css/login.css">
  <link rel="stylesheet" href="css/global.css">
  <link rel="icon" href="/img/logo_cartoonclub.ico" type="image/x-icon">
  <link rel="shortcut icon" href="/img/logo_cartoonclub.ico" type="image/x-icon">
  <link rel="icon" href="/img/logo_cartoonclub.png" sizes="32x32" type="image/png">
</head>

<body>
  <!-- Navbar Component -->
  <div id="navbar"></div>

  <div class="center">
    <img src="img/Logo Cartoon Club.png" alt="Logo" class="logo" />
    <div class="login-box">
      <div class="login-title">เข้าสู่ระบบ</div>
      <form id="loginForm">
        <div class="input-group">
          <input type="email" class="input-field" id="loginEmail" placeholder="อีเมล" required>
        </div>
        <div class="input-group">
          <input type="password" class="input-field" id="loginPassword" placeholder="รหัสผ่าน" required>
        </div>
        <button type="submit" class="login-btn">เข้าสู่ระบบ</button>
      </form>
      <div class="forgot-link"><a href="forgot.html">หากลืมรหัสผ่าน</a></div>
      <div class="remember-group">
        <input type="checkbox" id="rememberMe" />
        <span class="remember-text">จดจำข้อมูลของฉัน</span>
      </div>
      <div class="register-link">หากยังไม่คุ้นกับ Cartoon Club <a href="register.html">ลงทะเบียนตอนนี้</a></div>
      <div class="recaptcha">หน้านี้ได้รับการป้องกันโดย Google reCAPTCHA เพื่อตรวจสอบว่าคุณไม่ใช่บอต<br><a href="#"
          class="recaptcha-link">ดูข้อมูลเพิ่มเติม</a></div>
    </div>
  </div>

  <!-- Footer Component -->
  <div id="footer"></div>

  

  <script type="module" src="js/navbar.js"></script>
  <script src="js/footer.js"></script>
  
  <script type="module">
  import { login, getUserDoc, resendVerification, logout } from './firebase-controller.js';

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('loginForm');
      if (form) {
        form.addEventListener('submit', async function (e) {
          e.preventDefault();
          const email = document.getElementById('loginEmail').value;
          const password = document.getElementById('loginPassword').value;
          try {
            const cred = await login(email, password);
            const user = cred.user;

            const uid = user && user.uid;
            let role = 'user';
            if (uid) {
              try {
                const userDoc = await getUserDoc(uid);
                if (userDoc && userDoc.exists()) {
                  role = userDoc.data().role || 'user';
                }
              } catch (err) {
                console.warn('Could not read user doc:', err);
              }
            }

            // Enforce email verification for non-admin users
            if (user && !user.emailVerified && role !== 'admin') {
              // sign out the user immediately
              try { await logout(); } catch (e) { /* ignore */ }

              // show modal instructing user to verify email and offer resend
              showVerifyModal('กรุณาตรวจสอบอีเมลเพื่อยืนยันตัวตนก่อน', async () => {
                try {
                  // Attempt resend (this requires a User object; passing `user` obtained from sign-in)
                  await resendVerification(user);
                  showPopup('ส่งอีเมลยืนยันเรียบร้อยแล้ว กรุณาตรวจสอบกล่องจดหมาย (หรือโฟลเดอร์ Spam)');
                } catch (err) {
                  showPopup('ไม่สามารถส่งอีเมลยืนยันได้: ' + (err && err.message ? err.message : String(err)));
                }
              });

              return; // stop login flow
            }

            if (role === 'admin') {
              // Direct redirect for admin (no success modal)
              window.location.href = 'dashboard.html';
            } else {
              // Direct redirect for normal users (no success modal). Respect `next` param
              const params = new URLSearchParams(window.location.search);
              const next = params.get('next');
              window.location.href = next ? next : 'index.html';
            }
          } catch (err) {
            showPopup('ล็อคอินไม่สำเร็จ: ' + err.message);
          }
        });
      }
    });

    function showPopup(message, callback) {
      // Remove existing popup if any
      const existing = document.getElementById('loginPopup');
      if (existing) existing.remove();

      // Create modal structure using the project's modal classes so it picks up modal styling
      const wrapper = document.createElement('div');
      wrapper.id = 'loginPopup';
      wrapper.className = 'modal show';
      wrapper.innerHTML = `
        <div class="modal-content modal-figma" role="dialog" aria-modal="true">
          <div class="modal-figma-inner">
            <div class="modal-figma-text">
              <h1 class="modal-figma-title">${message}</h1>
            </div>
          </div>
          <div class="modal-footer modal-footer-figma">
            <button type="button" class="btn-figma-primary" id="loginPopupOk">ตกลง</button>
          </div>
        </div>
      `;

      // Append and focus
      document.body.appendChild(wrapper);

      // Prevent page scroll while modal is open
      document.body.style.overflow = 'hidden';

      // Close handler
      function closePopup(doCallback = false) {
        const el = document.getElementById('loginPopup');
        if (el) el.remove();
        document.body.style.overflow = '';
        document.removeEventListener('keydown', onKeyDown);
        if (doCallback && typeof callback === 'function') callback();
      }

      // Click outside to close
      wrapper.addEventListener('click', (e) => {
        if (e.target === wrapper) closePopup(false);
      });

      // ESC to close
      function onKeyDown(e) {
        if (e.key === 'Escape') closePopup(false);
      }
      document.addEventListener('keydown', onKeyDown);

      // OK button
      const okBtn = document.getElementById('loginPopupOk');
      if (okBtn) {
        okBtn.addEventListener('click', () => closePopup(true));
      }
    }

    // Modal for unverified email with an option to resend
    function showVerifyModal(message, onResend) {
      const existing = document.getElementById('verifyModal');
      if (existing) existing.remove();

      const wrapper = document.createElement('div');
      wrapper.id = 'verifyModal';
      wrapper.className = 'modal show';
      wrapper.innerHTML = `
        <div class="modal-content modal-figma" role="dialog" aria-modal="true">
          <div class="modal-figma-inner">
            <div class="modal-figma-text">
              <h1 class="modal-figma-title">${message}</h1>
              <p style="margin-top:8px; color: #555;">หากไม่ได้รับอีเมล ให้กดปุ่ม "ส่งอีเมลยืนยันอีกครั้ง"</p>
            </div>
          </div>
          <div class="modal-footer modal-footer-figma">
            <button type="button" class="btn-figma-secondary" id="verifyModalClose">ปิด</button>
            <button type="button" class="btn-figma-primary" id="verifyModalResend">ส่งอีเมลอีกครั้ง</button>
          </div>
        </div>
      `;

      document.body.appendChild(wrapper);
      document.body.style.overflow = 'hidden';

      wrapper.addEventListener('click', (e) => { if (e.target === wrapper) close(false); });

      function close(doCallback = false) {
        const el = document.getElementById('verifyModal');
        if (el) el.remove();
        document.body.style.overflow = '';
        if (doCallback && typeof onResend === 'function') onResend();
      }

      document.getElementById('verifyModalClose').addEventListener('click', () => close(false));
      document.getElementById('verifyModalResend').addEventListener('click', async () => {
        // call the provided callback to perform resend
        try {
          await onResend();
          close(false); // close verify modal after resending
        } catch (err) {
          console.error('Resend failed', err);
        }
      });
    }
  </script>
</body>

</html>